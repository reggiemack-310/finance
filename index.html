<!DOCTYPE html>
<html>
<head>
    <title>
    </title>
    <style> 
    .symbol {}
    </style>
    
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link href='highlighter/shCore.css' rel='stylesheet' type='text/css'/>
    <link href='highlighter/shThemeDefault.css' rel='stylesheet' type='text/css'/>
    <script type="text/javascript" src="js/d3.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/crossfilter.js"></script>
	<script type="text/javascript" src="js/dc.js"></script>
	<script src='highlighter/shCore.js' type='text/javascript'></script>
	<script src="highlighter/shAutoloader.js" type="text/javascript"></script>
	<script src='highlighter/shBrushJScript.js' type='text/javascript'></script>
	<script src='highlighter/shBrushXml.js' type='text/javascript'></script>


<style>
    #monthly-volume-chart g.y{ display: none; }
    #tickers-chart rect {color: blue;}
</style>

</head>
<body>
<div id="a"></div>
<div id="historicData"></div>
<script>

$(function() {
    $( "#fromDate" ).datepicker( { dateFormat: 'yymmdd' }).val();
    $( "#toDate" ).datepicker( { dateFormat: 'yymmdd' }).val();
});

var recentTickers = getCookie('recentTickers').split(',');
var currentTickers = [];
var historicData = new Object();
d3.selectAll("#version").text(dc.version);

function defaultChartData() {
	var myJson = '[{"volume": "12835000", "ticker": "TSLA", "high": "162.30", "adjclose": "161.84", "low": "155.00", "date": "23/08/2013", "close": "161.84", "open": "157.00"}, {"volume": "1026900", "ticker": "SCTY", "high": "35.18", "adjclose": "34.31", "low": "34.21", "date": "24/08/2013", "close": "34.31", "open": "34.62"}, {"volume": "12835000", "ticker": "TSLA", "high": "162.30", "adjclose": "161.84", "low": "155.00", "date": "24/08/2013", "close": "161.84", "open": "157.00"}]';
	return JSON.parse(myJson);
}


data = defaultChartData();

var s = getCookie('Searches');

function parseSearches(searches) {
    searches = searches.split('&');
    for (var i=0; i<searches.length; i++) {
        // search = searches[i].split('&');
        // console.log(search);
        // tickers = search[0].substr(3, search[0].length);
        // from = search[1].substr(5, search[0].length);
        // to = search[2].substr(2, search[2].length);
        // console.log(tickers, from, to);
    };
}

parseSearches(s);

function createURL(tickers) {
    var baseURL = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D'http%3A%2F%2Fdownload.finance.yahoo.com%2Fd%2Fquotes.csv%3Fs%3D";
    var paramsURL = "6f%3Dsl1%26e%3D.csv'%20and%20columns%3D'symbol%2Cprice'&format=json&diagnostics=true";//&callback=cbfunc";
    tickersURL = "";
    for(var i=0; i<tickers.length; i++) {
        tickersURL += tickers[i] + "%2C" };
    tickersURL = tickersURL.substr(0, tickersURL.length-1)

    URL = baseURL + tickersURL + paramsURL;
    return URL;
};

$(function() {
    var availableTags = ["AAPL", "ABC", "BP", "TLSA", "GOOG", "SCTY", "MSFT", "YHOO"];
    $( "#tickers" ).autocomplete({
      source: availableTags
    });
  });

function renderRecentQuotes(data) {
    var div = document.getElementById('quotes');
    div.innerHTML = '<table>'
    for (var i=0; i<data.length; i++) {
        if (data[i].price != 0) { div.innerHTML = div.innerHTML + '<tr><td>' + data[i].symbol + '</td><td style="width:100px"></td><td>' + data[i].price + '</td></tr><br>'; }
    div.innerHTML += '</table>'
    }
}

function deleteDiv(div) {
    div.parentNode.removeChild(div);
}

function updateRecentQuotes(url) {
    $.getJSON(url,
        function(data) {
            renderRecentQuotes(data.query.results.row); }
    ); }

window.setInterval(updateRecentQuotes(createURL(recentTickers)), 10000);

function inArray(array, value) {
    for (var i=0; i<array.length; i++) {
        if (array[i] == value) { return true; }
    }
    return false;
}

function addTicker()
  {
  var ticker = document.getElementById("tickers").value;
  if (inArray(currentTickers, ticker) == false && ticker != '') { currentTickers.push(ticker); }
  if (inArray(recentTickers, ticker) == false && ticker != '') { 
    recentTickers.push(ticker);
    cval = getCookie('recentTickers');
    if (cval == "") { cval = ticker }
    else { cval = cval + ',' + ticker; }
    createCookie('recentTickers', cval);
 }
  
  URL = createURL(recentTickers);
  updateRecentQuotes(URL);

  var div = document.getElementById('currentTickers');
  div.innerHTML = div.innerHTML + '<div onclick="deleteDiv(this)" id=current' + ticker + ' style="width:60px; background-color: green">' + ticker + ' x </div>';
  document.getElementById('tickers').value = '';
  }

function buildHistURL(ticker, fromDate, toDate) {
    fromDate = fromDate.toString(), toDate = toDate.toString();
    var fromYear = fromDate.substr(0,4), fromMonth = fromDate.substr(4,2)-1, fromDay = fromDate.substr(6,2)
    var toYear = toDate.substr(0,4), toMonth = toDate.substr(4,2)-1, toDay = toDate.substr(6,2)
    return "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D'http%3A%2F%2Fichart.finance.yahoo.com%2Ftable.csv%3Fs%3D" + ticker + "%26d%3D" + toMonth + "%26e%3D" + toDay + "%26f%3D" + toYear + "%26g%3Dd%26a%3D" + fromMonth + "%26b%3D" + fromDay + "%26c%3D" + fromYear + "%26ignore%3D.csv'%20and%20columns%3D'Date%2COpen%2CHigh%2CLow%2CClose%2CVolume%2CAdjClose'&format=json&diagnostics=true"
};


function renderHistoricString(historicString) {
	var hDiv = document.getElementById('historicData');
	hDiv.innerHTML = historicString;
}

function getHistoric() {
    addTicker();
    var fromDate = document.getElementById('fromDate').value;
    var toDate = document.getElementById('toDate').value;
    if (toDate === '') { // Default to today
        var today = new Date();
        var year = today.getFullYear().toString(), month = (today.getMonth()+1).toString(), day = today.getDate().toString();
        if (day.length == 1) { today = '0' + today; };
        if (month.length == 1) { month = '0' + month; };
        toDate = year + month + day;
    }
    if (fromDate === '' ) { // Default to 1 year from start date
        fromDate = (toDate - 10000).toString();
    };
    var jxhr = [], result = [], urls = [];
    var histString = "date,open,high,low,close,adjclose,volume,ticker\n";
    var consolData = [];
    for (var i=0; i<currentTickers.length; i++) {
    	histURL = buildHistURL(currentTickers[i], fromDate, toDate);
    	urls.push(histURL);
    }
    $.each(urls, function(i, url) {
    	jxhr.push($.getJSON(url, function (data) {
    		result[i] = data.query.results; })
    	);
    })
    $.when.apply($, jxhr).done(function() {
    	for (var i=0; i<result.length; i++) {
    		var Ticker = currentTickers[i], tickerData = result[i].row;
    		for (var j=1; j<tickerData.length; j++) {
    			line = tickerData[j];
    			var newLine = new Object();
    			newLine.date = line['Date'], newLine.open = line.Open, newLine.high = line.High, newLine.low = line.Low, newLine.close = line.Close, newLine.volume = line.Volume, newLine. adjclose = line.AdjClose, newLine.ticker = Ticker
    			histString += line['date'] + ',' + line.open + ',' + line.high + ',' + line.low + ',' + line.close + ',' + line.adjclose + ',' + line.volume + ',' + Ticker + '\n';
    			// line.ticker = Ticker;
    			consolData.push(newLine);
    		}
    	}
    	myJson = consolData;
    	data = JSON.parse(JSON.stringify(myJson));
    	draw(data);
    });
}

function createCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    }
    else var expires = "";
    document.cookie = name + "=" + value + expires + "; path=/";
}

function getCookie(c_name) {
    if (document.cookie.length > 0) {
        c_start = document.cookie.indexOf(c_name + "=");
        if (c_start != -1) {
            c_start = c_start + c_name.length + 1;
            c_end = document.cookie.indexOf(";", c_start);
            if (c_end == -1) {
                c_end = document.cookie.length;
            }
            return unescape(document.cookie.substring(c_start, c_end));
        }
    }
    return "";
}

// function titleCharts() {
// 	var chartIDs = ['yearly-bubble-chart', 'gain-loss-chart', 'quarter-chart', 'day-of-week-chart', 'fluctuation-chart', 'tickers-chart', 'price-chart', 'Volume-chart', 'dc-data-count'];

// 	var chartTitles = ['<strong>Yearly Performance</strong> (x: index gain, y: index gain(%), radius: fluctuation/index ratio, color:
//         gain/loss)', '<strong>Days by Gain/Loss</strong>', '<strong>Quarters</strong>', '<strong>Day of Week</strong>', '<strong>Days by Fluctuation(%)</strong><span class="reset" style="display: none;">range: <span class="filter"></span></span>', '<strong>Tickers</strong><span class="reset" style="display: none;">range: <span class="filter"></span></span>', '<strong>PriceChart</strong><span class="reset" style="display: none;">range: <span class="filter"></span></span>', ' <strong>VolumeChart</strong><span class="reset" style="display: none;">range: <span class="filter"></span></span>', '<span class="filter-count"></span> selected out of <span class="total-count"></span> records |']
// 	for (var i=0; i<chartIDs.length; i++) {
// 		var div = document.getElementById(chartIDs[i]);
// 		div.innerHTML = chartTitles[i] + div.innerHTML;
// 	}
// }

</script>

<h1 id="myHeader" onclick="getHistoric()" style="background-color:blue; text-align: center;">submit</h1>
<input type="text" width="250px" placeholder='tickers' id="tickers" onkeydown="if (event.keyCode == 13) addTicker()">
<input type="text" width="250px" placeholder='from' id="fromDate">
<input type="text" value="" width="250px" placeholder='to' id="toDate">
<div id="currentTickers"></div>
<br><div id="quotes"></div>

<div class="container">

<div id="price-chart">
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:priceChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div id="Volume-chart">
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:VolumeChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
    <div id="gain-loss-chart">
        <a class="reset" href="javascript:gainOrLossChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>

    <div id="quarter-chart">
        <a class="reset" href="javascript:quarterChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>

    <div id="day-of-week-chart">
        <a class="reset" href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>

    <div id="fluctuation-chart">
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>

	<div id="tickers-chart">
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:tickersChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
    <div id="yearly-bubble-chart" class="dc-chart">
        <a class="reset" href="javascript:yearlyBubbleChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
    <div>
        <div class="dc-data-count">
            <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a
                href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
        </div>
    </div>
    <!-- //date,ticker, open,high,low,close,adjclose,volume -->
    <table class="table table-hover dc-data-table" style="width: 750px; margin-left: 150px">
        <thead><tr class="header">
            <th>Date</th>
            <th>Ticker</th>
            <th>Open</th>
            <th>High</th>
            <th>Low</th>
            <th>Close</th>
            <th>Adj Close</th>
            <th>Volume</th>
        </tr></thead>
    </table>
</div>

<div id="lists"><div id="flight-list" class="list"></div></div>


</div>

<script type="text/javascript">

var gainOrLossChart = dc.pieChart("#gain-loss-chart");
var fluctuationChart = dc.barChart("#fluctuation-chart");
var quarterChart = dc.pieChart("#quarter-chart");
var dayOfWeekChart = dc.rowChart("#day-of-week-chart");
var tickersChart = dc.rowChart("#tickers-chart");
var yearlyBubbleChart = dc.bubbleChart("#yearly-bubble-chart");
var priceChart = dc.compositeChart("#price-chart");
var VolumeChart = dc.compositeChart("#Volume-chart");

function draw(data) {
            var dateFormat = d3.time.format("%Y-%m-%d");
            var numberFormat = d3.format(".2f");
            var minDate = new Date(2100, 0, 1), maxDate = new Date(1900, 0, 1);
            var nestByDate = d3.nest()
                .key(function(d) { return d3.time.day(d.date); });

            var sum = function(arr) {
                var total = 0;
                for (var i=0; i<arr.length; i++)
                { total += parseFloat(arr[i]) }
                return total;
            };

            data.forEach(function (d, i) {
                d.dd = dateFormat.parse(d.date);
                d.month = d3.time.month(d.dd); // pre-calculate month for better performance
                d.year = d.dd.getFullYear();
                d.adjclose = parseFloat(d.adjclose).toFixed(2);
                if (d.dd < minDate) { minDate = d.dd; };
                if (d.dd > maxDate) { maxDate = d.dd; };
                if ((i < data.length-1) && (d.ticker == data[i+1].ticker)) {
                        d.priorClose = parseFloat(data[i+1].adjclose) }
                else { d.priorClose = parseFloat(d.open) }
            });

            // feed it through crossfilter
            var ndx = crossfilter(data);
            var all = ndx.groupAll();

            var yearlyDimension = ndx.dimension(function (d, i) {
                return d3.time.year(d.dd); });
            
            var yearlyPerformanceGroup = yearlyDimension.group().reduce(
                    function (p, v) {
                        ++p.count;
                        p.absGain += v.adjclose - v.priorClose;
                        p.fluctuation += Math.abs(v.adjclose - v.priorClose);
                        p.sumIndex += (parseFloat(v.adjclose) + v.priorClose) / 2;
                        p.avgIndex = p.sumIndex / p.count;
                        p.percentageGain = (p.absGain / p.avgIndex) * 100;
                        p.fluctuationPercentage = (p.fluctuation / p.avgIndex) * 100;
                        return p; },

                    function (p, v) {
                        --p.count;
                        p.absGain -= v.adjclose - v.priorClose;
                        p.fluctuation -= Math.abs(v.adjclose - v.priorClose);
                        p.sumIndex -= (parseFloat(v.adjclose) + v.priorClose) / 2;
                        p.avgIndex = p.sumIndex / p.count;
                        p.percentageGain = (p.absGain / p.avgIndex) * 100;
                        p.fluctuationPercentage = (p.fluctuation / p.avgIndex) * 100;
                        return p; },

                    function () {
                        return {count: 0, absGain: 0, fluctuation: 0, fluctuationPercentage: 0, sumIndex: 0, avgIndex: 0, percentageGain: 0}; }
            );

			var dateDimension = ndx.dimension(function (d) {
                return d.dd;
            });

            var moveMonths = ndx.dimension(function (d) {
                return d.month});

            var indexAvgByMonthGroup = moveMonths.group().reduce(
                function (p, v) {
                    if (v.adjclose <= p.min)
                        { p.candidates.unshift(v.adjclose); };
                    if (v.adjclose >= p.max()) 
                        { p.candidates.push(v.adjclose) };
                    return p; },
                function (p, v) {
                    var index = p.candidates.indexOf(v.adjclose);
                    if (index >= 0) { p.candidates.splice(index, 1) };
                        return p; },
                function () {
                    return {candidates: [],
                        max: function() { return (this.candidates.length > 0) ? (this.candidates[this.candidates.length - 1]) : null },
                        min: function() { return (this.candidates.length > 0) ? (this.candidates[0]) : null },
                        total: function() { return (sum(this.candidates))  },
                        avg: function() { return (sum(this.candidates) / this.candidates.length) } }}
                );

            var gainOrLoss = ndx.dimension(function (d) {
                return +d.open > +d.close ? "Loss" : "Gain"; });
            var gainOrLossGroup = gainOrLoss.group();

            var fluctuation = ndx.dimension(function (d) {
                return Math.round((d.adjclose - d.priorClose) / d.priorClose * 100); });
            
            var fluctuationGroup = fluctuation.group();

            var quarter = ndx.dimension(function (d) {
                var month = d.dd.getMonth();
                var quarter = 'Q' + (Math.ceil((month+1)/3));
                return quarter; });

            var quarterGroup = quarter.group().reduceSum(function (d) {
                return d.volume; });

            var tickers = ndx.dimension(function (d) {
                return d.ticker; });

            var tickersGroup = tickers.group();
            
            var prices = dateDimension.group().reduce(
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = v.adjclose;
                    return p; },
                
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = 0;
                    return p; },
                // init
                function () {
                    return {};}
            );

            var volumes = dateDimension.group().reduce(
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = v.volume/1000000;
                    return p; },
                
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = 0;
                    return p; },
                
                function () {
                    return {};
                }
            );

            var dayOfWeek = ndx.dimension(function (d) {
                var day = d.dd.getDay();
                switch (day) {
                    case 0: return "0.Sun";
                    case 1: return "1.Mon";
                    case 2: return "2.Tue";
                    case 3: return "3.Wed";
                    case 4: return "4.Thu";
                    case 5: return "5.Fri";
                    case 6: return "6.Sat";
                } });

            var dayOfWeekGroup = dayOfWeek.group();

            var colors = ["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"];

            yearlyBubbleChart.width(990)
                    .height(250)
                    .margins({top: 10, right: 50, bottom: 30, left: 40})
                    .dimension(yearlyDimension)
                    .group(yearlyPerformanceGroup)
                    .transitionDuration(1500)
                    .colors(["#a60000", "#ff0000", "#ff4040", "#ff7373", "#67e667", "#39e639", "#00cc00"])
                    .colorDomain([-12000, 12000])
                    .colorAccessor(function (d) { return d.value.absGain; })
                    .keyAccessor(function (p) { return p.value.absGain; })
                    .valueAccessor(function (p) { return p.value.percentageGain; })
                    .radiusValueAccessor(function (p) { return p.value.fluctuationPercentage; })
                    .maxBubbleRelativeSize(0.1)
                    .x(d3.scale.linear().domain([-2500, 2500]))
                    .y(d3.scale.linear().domain([-100, 100]))
                    .r(d3.scale.linear().domain([0, 4000]))
                    .elasticY(true)
                    .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(500)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .label(function (p) { return p.key.getFullYear(); })
                    .title(function (p) {
                        return p.key.getFullYear()
                                + "\n"
                                + "Index Gain: " + numberFormat(p.value.absGain) + "\n"
                                + "Index Gain in Percentage: " + numberFormat(p.value.percentageGain) + "%\n"
                                + "Fluctuation / Index Ratio: " + numberFormat(p.value.fluctuationPercentage) + "%";
                    })
                    .yAxis().tickFormat(function (v) { return v + "%"; });

                    yearlyBubbleChart.width(990)
                    .height(250)
                    .margins({top: 10, right: 50, bottom: 30, left: 40})
                    .dimension(yearlyDimension)
                    .group(yearlyPerformanceGroup)
                    .transitionDuration(1500)
                    .colors(["#a60000", "#ff0000", "#ff4040", "#ff7373", "#67e667", "#39e639", "#00cc00"])
                    .colorDomain([-12000, 12000])
                    .colorAccessor(function (d) { return d.value.absGain; })
                    .keyAccessor(function (p) { return p.value.absGain; })
                    .valueAccessor(function (p) { return p.value.percentageGain; })
                    .radiusValueAccessor(function (p) { return p.value.fluctuationPercentage; })
                    .maxBubbleRelativeSize(0.1)
                    .x(d3.scale.linear().domain([-2500, 2500]))
                    .y(d3.scale.linear().domain([-100, 100]))
                    .r(d3.scale.linear().domain([0, 4000]))
                    .elasticY(true)
                    .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(500)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .label(function (p) { return p.key.getFullYear(); })
                    .title(function (p) {
                        return p.key.getFullYear()
                                + "\n"
                                + "Index Gain: " + numberFormat(p.value.absGain) + "\n"
                                + "Index Gain in Percentage: " + numberFormat(p.value.percentageGain) + "%\n"
                                + "Fluctuation / Index Ratio: " + numberFormat(p.value.fluctuationPercentage) + "%";
                    })
                    .yAxis().tickFormat(function (v) { return v + "%"; });

            gainOrLossChart.width(150)
                    .height(150)
                    .radius(60)
                    .dimension(gainOrLoss)
                    .group(gainOrLossGroup)
                    .label(function (d) {
                        if(gainOrLossChart.hasFilter() && !gainOrLossChart.hasFilter(d.data.key))
                            return d.data.key + "(0%)";
                        return d.data.key + "(" + Math.floor(d.data.value / all.value() * 100) + "%)";
                    });

            quarterChart.width(150)
                    .height(150)
                    .radius(60)
                    .innerRadius(30)
                    .dimension(quarter)
                    .group(quarterGroup);

            tickersChart.width(150)
                .height(150)
                .margins({top: 20, left: 10, right: 10, bottom: 20})
                .group(tickersGroup)
                .dimension(tickers)
                .colors(colors)
                .label(function (d){
                    return d.key; })
                .title(function(d){return d.value;})
                .elasticX(true)
                .xAxis().ticks(4);
                // .renderlet(function (table) { table.selectAll("#tickers-chart").style('background-color', 'blue')});

            dayOfWeekChart.width(150)
                .height(150)
                .margins({top: 20, left: 10, right: 10, bottom: 20})
                .group(dayOfWeekGroup)
                .dimension(dayOfWeek)
                .colors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
                .label(function (d){
                    return d.key.split(".")[1];})
                .title(function(d){return d.value; })
                .elasticX(true)
                .xAxis().ticks(4);

            fluctuationChart.width(300)
                    .height(150)
                    .margins({top: 10, right: 50, bottom: 30, left: 40})
                    .dimension(fluctuation)
                    .group(fluctuationGroup)
                    .elasticY(true)
                    .centerBar(true)
                    .gap(1)
                    .round(dc.round.floor)
                    .x(d3.scale.linear().domain([-25, 25]))
                    .renderHorizontalGridLines(true)
                    .filterPrinter(function (filters) {
                        var filter = filters[0], s = "";
                        s += numberFormat(filter[0]) + "% -> " + numberFormat(filter[1]) + "%";
                        return s; })
                    .xAxis()
                    .tickFormat(function (v) {
                        return v + "%"; });

            dc.dataCount(".dc-data-count")
                    .dimension(ndx)
                    .group(all);
                    
            dc.dataTable(".dc-data-table")
                    .dimension(dateDimension)
                    .group(function (d) { var format = d3.format("02d");
                        return d.dd.getFullYear() + "/" + format((d.dd.getMonth() + 1)); })
                    .size(100)
                    .columns([
                        function (d) { return d.date; },
                        function (d) { return d.ticker; },
                        function (d) { return d.open; },
                        function (d) { return d.high; },
                        function (d) { return d.low; },
                        function (d) { return d.close; },
                        function (d) { return d.adjclose; },
                        function (d) { return d.volume; }
                    ])
                    // .sortBy(function (d) { return d.dd; })
                    // .order(d3.descending)
                    .renderlet(function (table) { table.selectAll(".dc-table-group").classed("info", true)})
                    // .renderlet(function (table) { table.selectAll("td").style("border", "1px solid #98abc5")})
                    .renderlet(function (table) { table.selectAll("td").style("text-align", "center")})
                    .renderlet(function (table) { table.selectAll("td").style("font-size", "10px")})
                    .renderlet(function (table) { table.selectAll("th").style("text-align", "center")})
                    ;



            function getProperty(o, prop) {
                if (o[prop] !== undefined) return o[prop];
                else return 0;
            }
            
            function getTickers(tickersGroup) {
                var tickerObjects = tickersGroup.all();
                var Tickers = []
                for (var i=0; i<tickerObjects.length; i++) {
                    Tickers.push(tickerObjects[i].key); };
                return Tickers;
            }

            Tickers = getTickers(tickersGroup);

            var genLineChart = function(ticker, color, Group) {
                var line = dc.lineChart(priceChart, ticker)
                    .group(Group, ticker)
                    .valueAccessor(function (d) { return parseFloat(getProperty(d.value, ticker)) })
                    .colors([color])
                    .renderArea(true)
                    .title(function (d) { var value = parseFloat(d.data.value[ticker]);
                        return ticker + "\n" + dateFormat(d.data.key) + "\n" + numberFormat(value); })
                return line;
            }
            
            var getCharts = function(Tickers, colors, Group) {
                var LineCharts = [];
                for (var i=0; i<Tickers.length; i++) {
                    var ticker = Tickers[i], color = colors[i];
                    lineChart = genLineChart(ticker, color, Group);
                    LineCharts.push(lineChart);
                }
                return LineCharts;
            }

            var priceCharts = getCharts(Tickers, colors, prices);
            var volumeCharts = getCharts(Tickers, colors, volumes);

            var color = d3.scale.ordinal().range(colors);
            
            // var legend = priceChart.selectAll(".legend")
            //     .data(Tickers)
            //     .enter().append("g")
            //     .attr("class", "legend")
            //     .attr("transform", function(d, i) { 
            //       return "translate(0," + i * 20 + ")"; });
            //     legend.append("rect").attr("x", 500-18).attr("width", 18).attr("height", 18).style("fill", color);
            //     legend.append("text").attr("x", 500-24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "end").text(function(d) { return d; });


            priceChart.width(990)
                .height(400)
                .transitionDuration(1000)
                .margins({top: 30, right: 50, bottom: 25, left: 100})
                .dimension('blah')
                .group(prices)
                .valueAccessor(function (d) {
                    return d.value.ticker; })
                .x(d3.time.scale().domain([minDate, maxDate]))
                .round(d3.time.month.round)
                .xUnits(d3.time.months)
                .elasticY(true)
                .elasticX(true)
                .renderHorizontalGridLines(true)
                .legend(dc.legend().x(800).y(10).itemHeight(13).gap(1))
                .brushOn(false)
                .rangeChart(VolumeChart)
                .compose(priceCharts)
                .xAxis()
                ;
            console.log(Tickers);
            priceChart.renderlet(function (table) { table.selectAll("g").data(Tickers)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", function(d, i) { 
                  return "translate(0," + i * 20 + ")"; })
                .append("rect").attr("x", 500-18).attr("width", 18).attr("height", 18).style("fill", '#dadaeb')
                .append("text").attr("x", 500-24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "end").text(function(d) { return d; });
             });

            VolumeChart.width(990)
                    .height(150)
                    .transitionDuration(1000)
                    .margins({top: 30, right: 50, bottom: 25, left: 100})
                    .dimension('blah')
                    .group(volumes)
                    .valueAccessor(function (d) {
                        return d.value.ticker; })
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .round(d3.time.month.round)
                    .xUnits(d3.time.months)
                    .elasticY(true)
                    .elasticX(true)
                    .renderHorizontalGridLines(true)
                    // .legend(dc.legend().x(800).y(0).itemHeight(13).gap(1))
                    .brushOn(true)
                    .compose(volumeCharts)
                    .xAxis();

        dc.renderAll();
        // }
        // );
}

</script>
<div class="clearfix"></div>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">
    SyntaxHighlighter.all();
</script>

</body>
</html>












