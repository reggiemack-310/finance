<!DOCTYPE html>
<html>
<head>
    <title>
    </title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <style>
    	.changeUp {color: green; display: inline-block; font-size: 10px; width:50px;}
    	.changeDown {color: red; display: inline-block; font-size: 10px; width:50px;}
    	.selected {color: blue; display: inline-block; margin-left: 15px; cursor: pointer; cursor: hand; }
    	.notSelected {color: #98abc5; display: inline-block; margin-left: 15px; cursor: pointer; cursor: hand; }
    	.button {margin: 15px 5px 5px 5px; border:2px solid; border-radius:5px; background-color:#98abc5; color: white; height: 25px; display: inline-block; border: #BBB solid 1px; width: 210px; text-align: center; cursor: pointer; cursor: hand; }
    	.quote {display: inline-block; font-size: 10px; width:50px; }
    	.tickers {margin: 2px 0px 0px 2px; font-size: 10px; text-align: center; color: white; width:50px; background-color: LightGreen; display: inline-block; border-radius:3px; cursor: pointer; cursor: hand; }
    	#search {font-size: 10px; text-decoration: underline; color:blue; text-align: left; margin-left: 10px }
    	.scroller {width:200px; height:200px; overflow:auto; background-color: light-grey; text-align: center;} 
    	.dates {border-radius:3px; width: 91px; }
    	.reset {font-size: 10px;}
    	.onHover, #onHover { cursor: pointer; cursor: hand; }

    </style>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link href='highlighter/shCore.css' rel='stylesheet' type='text/css'/>
    <link href='highlighter/shThemeDefault.css' rel='stylesheet' type='text/css'/>
    <script type="text/javascript" src="js/d3.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/crossfilter.js"></script>
	<script type="text/javascript" src="js/dc.js"></script>
	<script src='highlighter/shCore.js' type='text/javascript'></script>
	<script src="highlighter/shAutoloader.js" type="text/javascript"></script>
	<script src='highlighter/shBrushJScript.js' type='text/javascript'></script>
	<script src='highlighter/shBrushXml.js' type='text/javascript'></script>
</head>
<body>

<div class="container-fluid">
	<div class="span3">
		<div onclick="addTicker(document.getElementById('tickers').value); getHistoric(document.getElementById('fromDate').value, document.getElementById('toDate').value, currentTickers, frequency)" class="button">search</div>
		<input type="text" style="margin-left: 5px; width: 200px" placeholder='ticker' id="tickers" onkeydown="if (event.keyCode == 13) addTicker(document.getElementById('tickers').value);"><br>
		<input type="text" class="dates" style="margin-left: 5px;" placeholder='from' id="fromDate">
		<input type="text" class="dates" style="margin-left: 1px;" placeholder='to' id="toDate">
		<div onclick="updateFrequency(this.id);" id="dailyFreq" >daily</div>
		<div onclick="updateFrequency(this.id);" id="weeklyFreq" >weekly</div>
		<div onclick="updateFrequency(this.id);" id="monthlyFreq">monthly</div>
		<div id="currentTickers"></div>
		<div id="download" onclick="javascript:downloadJSON2CSV(data)"></div>
		<div id="clear" onclick="javascript:Clear()" style="margin-top: -10px"></div><br><br>
		<div style="text-align:center">
			search history
		</div>
		<div class="scroller">
			<div id="searches"></div>
		</div><br>
		<div style="text-align:center">
			recent quotes
		</div>
		<div class="scroller">
			<div id="quotes"></div>
		</div>
	</div>

	<div class="span9">
		<div id="price-chart">
	        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
	        <a class="reset" href="javascript:priceChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
		<div id="Volume-chart">
	        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
	        <a class="reset" href="javascript:VolumeChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
		<div id="fluctuation-chart">
			<a href="javascript:dc.filterAll(); dc.renderAll();" id="fluctuationChart" style="color: white;">reset filters</a>
	        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
	        <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
		<div id="tickers-chart">
	        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
	        <a class="reset" href="javascript:tickersChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
    	<div id="gain-loss-chart">
	        <a class="reset" href="javascript:gainOrLossChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
    	</div>
	    <div id="quarter-chart">
	        <a class="reset" href="javascript:quarterChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
	    <div id="day-of-week-chart">
	        <a class="reset" href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
	        <div class="clearfix"></div>
	    </div>
    	<div id="yearly-bubble-chart" class="dc-chart">
        	<a class="reset" href="javascript:yearlyBubbleChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
        	<div class="clearfix"></div>
    	</div>
    <div>
        <div class="dc-data-count" id="dataCount" style="color: white;">
            <span class="filter-count"></span> selected out of <span class="total-count"></span> records<br>
        </div>
    </div>
    <table class="table table-hover dc-data-table" style="width: 750px;">
        <thead><tr class="header">
            <th id="c1"></th>
            <th id="c2"></th>
            <th id="c3"></th>
            <th id="c4"></th>
            <th id="c5"></th>
            <th id="c6"></th>
            <th id="c7"></th>
            <th id="c8"></th>
        </tr></thead>
    </table>

<div id="lists">
	<div id="flight-list" class="list"></div>
</div>
	</div>
</div>


<script>

$(function() { // calendar popups
	var jq = $.noConflict();
    $( "#fromDate" ).datepicker( { dateFormat: 'yymmdd' }).val();
    $( "#toDate" ).datepicker( { dateFormat: 'yymmdd' }).val();
});

var recentTickers = getCookie('recentTickers').split(',');
var currentTickers = [];
var historicData = new Object();
var frequency = 'd';
updateFrequency('dailyFreq');
d3.selectAll("#version").text(dc.version);
updateRecentQuotes(createURL(recentTickers));
populateSearches();


function createURL(tickers) {
    var baseURL = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D'http%3A%2F%2Fdownload.finance.yahoo.com%2Fd%2Fquotes.csv%3Fs%3D";
    var paramsURL = "6f%3Dsl1p2%26e%3D.csv'%20and%20columns%3D'symbol%2Cprice%2Cchange'&format=json&diagnostics=true";
    tickersURL = "";
    for(var i=0; i<tickers.length; i++) {
        tickersURL += tickers[i] + "%2C" };
    tickersURL = tickersURL.substr(0, tickersURL.length-1)

    URL = baseURL + tickersURL + paramsURL;
    return URL;
};

$(function() {
    var availableTags = [];
    $( "#tickers" ).autocomplete({
      source: availableTags
    });
  });

function renderRecentQuotes(data) {
    var div = document.getElementById('quotes');
    div.innerHTML = '';
    for (var i=0; i<data.length; i++) {
    	var pchange = data[i].change.substr(0, data[i].change.length-1);
    	var pchangeStyle = "quote";
    	if (pchange>0) { pchangeStyle = 'changeUp' };
    	if (pchange<0) { pchangeStyle = 'changeDown' }
        if (data[i].price != 0) { div.innerHTML = div.innerHTML + '<div class="quote">' + data[i].symbol + '</div><div class="quote">' + data[i].price + '</div><div class="' + pchangeStyle + '";>' + data[i].change + '</div><br>'; }
    }
}

function deleteDiv(div) {
    div.parentNode.removeChild(div);
}

function updateRecentQuotes(url) {
    $.getJSON(url,
        function(data) {
            renderRecentQuotes(data.query.results.row); }
    ); }

function inArray(array, value) {
    for (var i=0; i<array.length; i++) {
        if (array[i] == value) { return true; }
    }
    return false;
}

function downloadJSON2CSV(objArray) {
	var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
	var str = 'Date,Open,High,Low,Close,AdjClose,PriorAdjClose,Volume,Ticker\n';

	for (var i=0; i<array.length; i++) {
		var line = '', ln = array[i]
		line += ln.date+','+ln.open+','+ln.high+','+ln.low+','+ln.close+','+ln.adjclose+','+ln.priorClose+','+ln.volume+','+ln.ticker;
		
		line.slice(0,line.Length-1); 
            str += line + '\r\n';
        }
        window.open( "data:text/csv;charset=utf-8," + escape(str))
    }

function addTicker(ticker) {
	ticker = ticker.replace(' ', '');
	if (ticker == '') { return null; }
	if (inArray(currentTickers, ticker) == false) { currentTickers.push(ticker); }
	if (inArray(recentTickers, ticker) == false) { 
		recentTickers.push(ticker);
		cval = getCookie('recentTickers');
	if (cval == "") { cval = ticker }
	else { cval = cval + ',' + ticker; }
	createCookie('recentTickers', cval);
 }
  
  var div = document.getElementById('currentTickers');
  div.innerHTML = div.innerHTML + '<div onclick="deleteDiv(this)" id=current' + ticker + ' class="tickers">' + ticker + ' x</div>';
  document.getElementById('tickers').value = '';
  }

function buildHistURL(ticker, fromDate, toDate) {
    fromDate = fromDate.toString(), toDate = toDate.toString();
    var fromYear = fromDate.substr(0,4), fromMonth = fromDate.substr(4,2)-1, fromDay = fromDate.substr(6,2)
    var toYear = toDate.substr(0,4), toMonth = toDate.substr(4,2)-1, toDay = toDate.substr(6,2)
    return "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D'http%3A%2F%2Fichart.finance.yahoo.com%2Ftable.csv%3Fs%3D" + ticker + "%26d%3D" + toMonth + "%26e%3D" + toDay + "%26f%3D" + toYear + "%26g%3D"+frequency+"%26a%3D" + fromMonth + "%26b%3D" + fromDay + "%26c%3D" + fromYear + "%26ignore%3D.csv'%20and%20columns%3D'Date%2COpen%2CHigh%2CLow%2CClose%2CVolume%2CAdjClose'&format=json&diagnostics=true"
};

function renderHistoricString(historicString) {
	var hDiv = document.getElementById('historicData');
	hDiv.innerHTML = historicString;
}

var freqConv = {'d': 'daily', 'w': 'weekly', 'm': 'monthly'};

function createCookie(name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    }
    else var expires = "";
    document.cookie = name + "=" + value + expires + "; path=/";
}

function getCookie(c_name) {
    if (document.cookie.length > 0) {
        c_start = document.cookie.indexOf(c_name + "=");
        if (c_start != -1) {
            c_start = c_start + c_name.length + 1;
            c_end = document.cookie.indexOf(";", c_start);
            if (c_end == -1) {
                c_end = document.cookie.length; }
            return unescape(document.cookie.substring(c_start, c_end));
        }
    }
    return "";
}

function populateSearches() {
	searches = getCookie('Searches').split('-');
	searchHTML = document.getElementById('searches').innerHTML;
	for (var i=0; i<searches.length; i++) {
		searchHTML += '<div class="onHover" onclick="parseSearch(this)" id="search">' + searches[i] + '</div>'; }
	document.getElementById('searches').innerHTML = searchHTML;
};

function parseSearch(div) {
	var params = div.innerHTML.split(' ');
	var tickers = params[0].split(',');
	var frequency = params[params.length-1];
	var fromDate = '', toDate = '';
	for (var i=1; i<params.length-1; i++) {
		if (params[i].substr(0,4)=='from') {
			fromDate = params[i].substr(5, params[i].length); }
		if (params[i].substr(0,2)=='to') {
			toDate = params[i].substr(3, params[i].length);}
	}
	for (var i=0; i<tickers.length; i++) {
		ticker = tickers[i]; addTicker(ticker);
	}
	getHistoric(fromDate, toDate, tickers, frequency);
}

function setSearchCookie(fromDate, toDate) {
	search = currentTickers.toString();
	if (fromDate!='') { search += ' from=' + fromDate.toString() };
	if (toDate!='') { search += ' to=' + toDate.toString() };
	search += ' frequency=' + freqConv[frequency];
	searches = getCookie('Searches');
	searches = search + '-' + searches;
	createCookie('Searches', searches);
}

function formatArea() {
    document.getElementById('download').className = 'button';
    document.getElementById('clear').className = 'button';
    document.getElementById('fluctuationChart').style.color = 'blue';
    document.getElementById('dataCount').style.color = 'blue';
    var Texts = ['Date','Ticker','Open','High','Low','Close','Adj Close','Volume', 'download', 'clear'];
    var IDs = ['c1','c2','c3','c4','c5','c6','c7','c8', 'download', 'clear'];
    for (var i=0; i<Texts.length; i++) {
    	document.getElementById(IDs[i]).innerHTML = Texts[i]; }
    }

function unFormatArea() {
    document.getElementById('download').className = '';
    document.getElementById('clear').className = '';
    document.getElementById('fluctuationChart').style.color = 'white';
    document.getElementById('dataCount').style.color = 'white';
    var IDs = ['c1','c2','c3','c4','c5','c6','c7','c8', 'download', 'clear'];
    for (var i=0; i<IDs.length; i++) {
    	document.getElementById(IDs[i]).innerHTML = ''; }
    }

function Clear() {
	unFormatArea();
	document.getElementById('currentTickers').innerHTML = '';
	data = '';
}


function getHistoric(fromDate, toDate, currentTickers, frequency) {
	updateRecentQuotes(createURL(recentTickers));

	if (currentTickers.length == 0) {
		document.getElementById('tickers').style.backgroundColor = '#ff7373';
		document.getElementById('tickers').style.color = 'white';
		document.getElementById('tickers').style.textAlign = 'center';
		document.getElementById('tickers').value = 'enter ticker';
		setTimeout(function() {
      		document.getElementById('tickers').style.backgroundColor = 'white';
      		document.getElementById('tickers').value = '';
      		document.getElementById('tickers').style.color = 'gray';
      		document.getElementById('tickers').style.textAlign = 'left';
      	}, 1000);
	return null; }

    setSearchCookie(fromDate, toDate);
    if (toDate === '') { // Default to today
        var today = new Date();
        var year = today.getFullYear().toString(), month = (today.getMonth()+1).toString(), day = today.getDate().toString();
        if (day.length == 1) { today = '0' + today; };
        if (month.length == 1) { month = '0' + month; };
        toDate = year + month + day; }

    if (fromDate === '' ) { // Default to 1 year from start date
        fromDate = (toDate - 10000).toString(); }
    
    var jxhr = [], result = [], urls = [], consolData = [];
    for (var i=0; i<currentTickers.length; i++) {
    	histURL = buildHistURL(currentTickers[i], fromDate, toDate);
    	urls.push(histURL);
    }
    $.each(urls, function(i, url) {
    	jxhr.push($.getJSON(url, function (data) {
    		result[i] = data.query.results; })
    	); })

    $.when.apply($, jxhr).done(function() {
    	for (var i=0; i<result.length; i++) {
    		var Ticker = currentTickers[i], tickerData = result[i].row;
    		for (var j=1; j<tickerData.length; j++) {
    			line = tickerData[j];
    			var newLine = new Object();
    			newLine.date = line['Date'], newLine.open = line.Open, newLine.high = line.High, newLine.low = line.Low, newLine.close = line.Close, newLine.volume = line.Volume, newLine. adjclose = line.AdjClose, newLine.ticker = Ticker
    			consolData.push(newLine);
    		}
    	}
    	myJson = consolData;
    	data = JSON.parse(JSON.stringify(myJson));
    	renderCharts(data);
    	formatArea();
    });
}

function updateFrequency(divID) {
	document.getElementById('dailyFreq').className = "notSelected";
	document.getElementById('weeklyFreq').className = "notSelected";
	document.getElementById('monthlyFreq').className = "notSelected";
	document.getElementById(divID).className = "selected";
	frequency = divID.substr(0, 1);
}

</script>

<script type="text/javascript">

var gainOrLossChart = dc.pieChart("#gain-loss-chart");
var fluctuationChart = dc.barChart("#fluctuation-chart");
var quarterChart = dc.pieChart("#quarter-chart");
var dayOfWeekChart = dc.rowChart("#day-of-week-chart");
var tickersChart = dc.rowChart("#tickers-chart");
var yearlyBubbleChart = dc.bubbleChart("#yearly-bubble-chart");
var priceChart = dc.compositeChart("#price-chart");
var VolumeChart = dc.compositeChart("#Volume-chart");

function renderCharts(data) {
            var dateFormat = d3.time.format("%Y-%m-%d");
            var numberFormat = d3.format(".2f");
            var minDate = new Date(2100, 0, 1), maxDate = new Date(1900, 0, 1);
            var nestByDate = d3.nest()
                .key(function(d) { return d3.time.day(d.date); });

            var sum = function(arr) {
                var total = 0;
                for (var i=0; i<arr.length; i++)
                { total += parseFloat(arr[i]) }
                return total;
            };

            data.forEach(function (d, i) {
                d.dd = dateFormat.parse(d.date);
                d.month = d3.time.month(d.dd); 
                d.year = d.dd.getFullYear();
                d.adjclose = parseFloat(d.adjclose).toFixed(2);
                if (d.dd < minDate) { minDate = d.dd; };
                if (d.dd > maxDate) { maxDate = d.dd; };
                if ((i < data.length-1) && (d.ticker == data[i+1].ticker)) {
                        d.priorClose = parseFloat(data[i+1].adjclose) }
                else { d.priorClose = parseFloat(d.open) }
            });

            var ndx = crossfilter(data);
            var all = ndx.groupAll();

            var yearlyDimension = ndx.dimension(function (d, i) {
                return d3.time.year(d.dd); });
            
            var yearlyPerformanceGroup = yearlyDimension.group().reduce(
                    function (p, v) {
                        ++p.count;
                        p.absGain += v.adjclose - v.priorClose;
                        p.fluctuation += Math.abs(v.adjclose - v.priorClose);
                        p.sumIndex += (parseFloat(v.adjclose) + v.priorClose) / 2;
                        p.avgIndex = p.sumIndex / p.count;
                        p.percentageGain = (p.absGain / p.avgIndex) * 100;
                        p.fluctuationPercentage = (p.fluctuation / p.avgIndex) * 100;
                        return p; },

                    function (p, v) {
                        --p.count;
                        p.absGain -= v.adjclose - v.priorClose;
                        p.fluctuation -= Math.abs(v.adjclose - v.priorClose);
                        p.sumIndex -= (parseFloat(v.adjclose) + v.priorClose) / 2;
                        p.avgIndex = p.sumIndex / p.count;
                        p.percentageGain = (p.absGain / p.avgIndex) * 100;
                        p.fluctuationPercentage = (p.fluctuation / p.avgIndex) * 100;
                        return p; },

                    function () {
                        return {count: 0, absGain: 0, fluctuation: 0, fluctuationPercentage: 0, sumIndex: 0, avgIndex: 0, percentageGain: 0}; }
            );

			var dateDimension = ndx.dimension(function (d) {
                return d.dd;
            });

            var moveMonths = ndx.dimension(function (d) {
                return d.month});

            var indexAvgByMonthGroup = moveMonths.group().reduce(
                function (p, v) {
                    if (v.adjclose <= p.min)
                        { p.candidates.unshift(v.adjclose); };
                    if (v.adjclose >= p.max()) 
                        { p.candidates.push(v.adjclose) };
                    return p; },
                function (p, v) {
                    var index = p.candidates.indexOf(v.adjclose);
                    if (index >= 0) { p.candidates.splice(index, 1) };
                        return p; },
                function () {
                    return {candidates: [],
                        max: function() { return (this.candidates.length > 0) ? (this.candidates[this.candidates.length - 1]) : null },
                        min: function() { return (this.candidates.length > 0) ? (this.candidates[0]) : null },
                        total: function() { return (sum(this.candidates))  },
                        avg: function() { return (sum(this.candidates) / this.candidates.length) } }}
                );

            var gainOrLoss = ndx.dimension(function (d) {
                return +d.open > +d.close ? "Loss" : "Gain"; });
            var gainOrLossGroup = gainOrLoss.group();

            var fluctuation = ndx.dimension(function (d) {
                return Math.round((d.adjclose - d.priorClose) / d.priorClose * 100); });
            
            var fluctuationGroup = fluctuation.group();

            var quarter = ndx.dimension(function (d) {
                var month = d.dd.getMonth();
                var quarter = 'Q' + (Math.ceil((month+1)/3));
                return quarter; });

            var quarterGroup = quarter.group().reduceSum(function (d) {
                return d.volume; });

            var tickers = ndx.dimension(function (d) {
                return d.ticker; });

            var tickersGroup = tickers.group();
            
            var prices = dateDimension.group().reduce(
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = v.adjclose;
                    return p; },
                
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = 0;
                    return p; },
                // init
                function () {
                    return {};}
            );

            var volumes = dateDimension.group().reduce(
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = v.volume/1000000;
                    return p; },
                
                function (p, v) {
                    ticker = v.ticker;
                    p[ticker] = 0;
                    return p; },
                
                function () {
                    return {};
                }
            );

            var dayOfWeek = ndx.dimension(function (d) {
                var day = d.dd.getDay();
                switch (day) {
                    case 0: return "0.Sun";
                    case 1: return "1.Mon";
                    case 2: return "2.Tue";
                    case 3: return "3.Wed";
                    case 4: return "4.Thu";
                    case 5: return "5.Fri";
                    case 6: return "6.Sat";
                } });

            var dayOfWeekGroup = dayOfWeek.group();

            var colors = ["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"];

            yearlyBubbleChart.width(500)
                    .height(200)
                    .margins({top: 10, right: 50, bottom: 30, left: 100})
                    .dimension(yearlyDimension)
                    .group(yearlyPerformanceGroup)
                    .transitionDuration(1500)
                    .colors(["#a60000", "#ff0000", "#ff4040", "#ff7373", "#67e667", "#39e639", "#00cc00"])
                    .colorDomain([-12000, 12000])
                    .colorAccessor(function (d) { return d.value.absGain; })
                    .keyAccessor(function (p) { return p.value.absGain; })
                    .valueAccessor(function (p) { return p.value.percentageGain; })
                    .radiusValueAccessor(function (p) { return p.value.fluctuationPercentage; })
                    .maxBubbleRelativeSize(0.2)
                    .x(d3.scale.linear().domain([-2500, 2500]))
                    .y(d3.scale.linear().domain([-100, 100]))
                    .r(d3.scale.linear().domain([0, 4000]))
                    .elasticY(true)
                    .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(500)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .label(function (p) { return p.key.getFullYear(); })
                    .title(function (p) {
                        return p.key.getFullYear()
                                + "\n"
                                + "change: " + numberFormat(p.value.absGain) + "\n"
                                + "% change : " + numberFormat(p.value.percentageGain) + "%\n"
                                + "Fluctuation / Index Ratio: " + numberFormat(p.value.fluctuationPercentage) + "%";
                    })
                    .yAxis().tickFormat(function (v) { return v + "%"; });

            gainOrLossChart.width(110)
                    .height(150)
                    .radius(40)
                    .dimension(gainOrLoss)
                    .group(gainOrLossGroup)
                    .label(function (d) {
                        if(gainOrLossChart.hasFilter() && !gainOrLossChart.hasFilter(d.data.key))
                            return d.data.key + "(0%)";
                        return d.data.key + "(" + Math.floor(d.data.value / all.value() * 100) + "%)";
                    });

            quarterChart.width(100)
                    .height(150)
                    .radius(50)
                    .innerRadius(30)
                    .dimension(quarter)
                    .group(quarterGroup);

            tickersChart.width(125)
                .height(currentTickers.length*100)
                .margins({top: 10, left: 10, right: 10, bottom: 20})
                .group(tickersGroup)
                .dimension(tickers)
                .colors(colors)
                .label(function (d){
                	console.log(d.key)
                    return d.key; })
                .title(function(d){return d.key;})
                .elasticX(true)
                .xAxis().ticks(4);

            dayOfWeekChart.width(100)
                .height(170)
                .margins({top: 10, left: 10, right: 10, bottom: 20})
                .group(dayOfWeekGroup)
                .dimension(dayOfWeek)
                .colors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
                .label(function (d){
                    return d.key.split(".")[1];})
                .title(function(d){return d.value; })
                .elasticX(true)
                .xAxis().ticks(4);

            fluctuationChart.width(250)
                    .height(150)
                    .margins({top: 30, right: 0, bottom: 30, left: 30})
                    .dimension(fluctuation)
                    .group(fluctuationGroup)
                    .elasticY(true)
                    .centerBar(true)
                    .gap(1)
                    .round(dc.round.floor)
                    .x(d3.scale.linear().domain([-25, 25]))
                    .renderHorizontalGridLines(true)
                    .filterPrinter(function (filters) {
                        var filter = filters[0], s = "";
                        s += numberFormat(filter[0]) + "% -> " + numberFormat(filter[1]) + "%";
                        return s; })
                    .xAxis()
                    .tickFormat(function (v) {
                        return v + "%"; });

            dc.dataCount(".dc-data-count")
                    .dimension(ndx)
                    .group(all);
                    
            dc.dataTable(".dc-data-table")
                    .dimension(dateDimension)
                    .group(function (d) { var format = d3.format("02d");
                        return d.dd.getFullYear() + "/" + format((d.dd.getMonth() + 1)); })
                    .size(100)
                    .columns([
                        function (d) { return d.date; },
                        function (d) { return d.ticker; },
                        function (d) { return d.open; },
                        function (d) { return d.high; },
                        function (d) { return d.low; },
                        function (d) { return d.close; },
                        function (d) { return d.adjclose; },
                        function (d) { return d.volume; }
                    ])
                    .sortBy(function (d) { return d.dd; })
                    .order(d3.descending)
                    .renderlet(function (table) { table.selectAll(".dc-table-group").classed("info", true)})
                    // .renderlet(function (table) { table.selectAll("td").style("border", "1px solid #98abc5")})
                    .renderlet(function (table) { table.selectAll("td").style("text-align", "center")})
                    .renderlet(function (table) { table.selectAll("td").style("font-size", "10px")})
                    .renderlet(function (table) { table.selectAll("th").style("text-align", "center")})
                    ;



            function getProperty(o, prop) {
                if (o[prop] !== undefined) return o[prop];
                else return 0;
            }
            
            function getTickers(tickersGroup) {
                var tickerObjects = tickersGroup.all();
                var Tickers = []
                for (var i=0; i<tickerObjects.length; i++) {
                    Tickers.push(tickerObjects[i].key); };
                return Tickers;
            }

            Tickers = getTickers(tickersGroup);

            var genLineChart = function(ticker, color, Group) {
                var line = dc.lineChart(priceChart, ticker)
                    .group(Group, ticker)
                    .valueAccessor(function (d) { return parseFloat(getProperty(d.value, ticker)) })
                    .colors([color])
                    .renderArea(true)
                    .title(function (d) { var value = parseFloat(d.data.value[ticker]);
                        return ticker + "\n" + dateFormat(d.data.key) + "\n" + numberFormat(value); })
                return line;
            }
            
            var getCharts = function(Tickers, colors, Group) {
                var LineCharts = [];
                for (var i=0; i<Tickers.length; i++) {
                    var ticker = Tickers[i], color = colors[i];
                    lineChart = genLineChart(ticker, color, Group);
                    LineCharts.push(lineChart);
                }
                return LineCharts;
            }

            var priceCharts = getCharts(Tickers, colors, prices);
            var volumeCharts = getCharts(Tickers, colors, volumes);

            var color = d3.scale.ordinal().range(colors);

            priceChart.width(500)
                .height(250)
                .transitionDuration(1000)
                .margins({top: 30, right: 50, bottom: 25, left: 100})
                .dimension(dateDimension)
                .group(prices)
                .valueAccessor(function (d) {
                    return d.value.ticker; })
                .x(d3.time.scale().domain([minDate, maxDate]))
                .round(d3.time.month.round)
                .xUnits(d3.time.months)
                .elasticY(true)
                .elasticX(true)
                .renderHorizontalGridLines(true)
                .legend(dc.legend().x(800).y(10).itemHeight(13).gap(1))
                .brushOn(false)
                .rangeChart(VolumeChart)
                .compose(priceCharts)
                .xAxis()
                ;

            priceChart.renderlet(function (table) { table.selectAll("g").data(Tickers)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", function(d, i) { 
                  return "translate(0," + i * 20 + ")"; })
                .append("rect").attr("x", 500-18).attr("width", 18).attr("height", 18).style("fill", '#dadaeb')
                .append("text").attr("x", 500-24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "end").text(function(d) { return d; });
             });

            VolumeChart.width(500)
                    .height(125)
                    .transitionDuration(1000)
                    .margins({top: 30, right: 50, bottom: 25, left: 100})
                    .dimension(dateDimension)
                    .group(volumes)
                    .valueAccessor(function (d) {
                        return d.value.ticker; })
                    .x(d3.time.scale().domain([minDate, maxDate]))
                    .round(d3.time.month.round)
                    .xUnits(d3.time.months)
                    .elasticY(true)
                    .elasticX(true)
                    .renderHorizontalGridLines(true)
                    // .legend(dc.legend().x(800).y(0).itemHeight(13).gap(1))
                    .brushOn(true)
                    .compose(volumeCharts)
                    .xAxis();

        dc.renderAll();
}

</script>
<div class="clearfix"></div>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">
    SyntaxHighlighter.all();
</script>

</body>
</html>












